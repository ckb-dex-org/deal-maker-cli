<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web UI</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.0.3/pure-min.css"
      crossorigin="anonymous"
    />
    <style>
      table {
        width: 100%;
      }

      table.orders td:not(:first-child) {
        min-width: 120px;
      }

      table.deals td:not(:first-child) {
        min-width: 120px;
      }

      table.orders tbody td:last-child {
        max-width: 30px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <h3>Ask Orders</h3>
    <table class="pure-table pure-table-bordered orders" id="ask-orders">
      <thead>
        <tr>
          <th>#</th>
          <th>Price</th>
          <th>Capacity</th>
          <th>Order Amount</th>
          <th>SUDT Amount</th>
          <th>Out Point</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Bid Orders</h3>
    <table class="pure-table pure-table-bordered orders" id="bid-orders">
      <thead>
        <tr>
          <th>#</th>
          <th>Price</th>
          <th>Capacity</th>
          <th>Order Amount</th>
          <th>SUDT Amount</th>
          <th>Out Point</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>History</h3>
    <table class="pure-table pure-table-bordered" id="deals">
      <thead>
        <tr>
          <th>#</th>
          <th>Tx Hash</th>
          <th>Fee</th>
          <th>Status</th>
          <th>Created Time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Sync State</h3>
    <table class="pure-table pure-table-bordered" id="sync-state">
      <thead>
        <tr>
          <th>Name</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Config</h3>
    <table class="pure-table pure-table-bordered" id="config">
      <thead>
        <tr>
          <th>Name</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <hr />

    <h3>Set Config</h3>
    <form class="pure-form" id="remote-url">
      <fieldset>
        <legend>Set Remote URL</legend>
        <input name="url" type="url" aria-label="remote url" placeholder="Remote URL" />
        <button type="submit" class="pure-button pure-button-primary">Apply</button>
      </fieldset>
    </form>

    <form class="pure-form" id="key-file">
      <fieldset>
        <legend>Set Key File</legend>
        <input name="key" type="text" aria-label="key file" placeholder="Key File" />
        <button type="submit" class="pure-button pure-button-primary">Apply</button>
      </fieldset>
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <script>
      const socket = io()
      const askOrderTable = document.querySelector('#ask-orders tbody')
      const bidOrderTable = document.querySelector('#bid-orders tbody')
      const dealTable = document.querySelector('#deals tbody')
      const syncStateTable = document.querySelector('#sync-state tbody')
      const configTable = document.querySelector('#config tbody')
      const remoteUrlForm = document.querySelector('#remote-url')
      const keyFileForm = document.querySelector('#key-file')

      remoteUrlForm.addEventListener('submit', e => {
        e.preventDefault()
        const { value } = e.target.url
        socket.emit('set-config', 'url', value)
        window.alert('Please restart deal maker cli')
        return false
      })

      keyFileForm.addEventListener('submit', e => {
        e.preventDefault()
        const { value } = e.target.key
        socket.emit('set-config', 'keyFile', value)
      })

      const updateOrderTable = (_table, _orders) => {
        const rows = _orders
          .map(
            (_order, _idx) =>
              `<tr>
            <td>${_idx + 1}</td>
            <td>${_order.price}</td>
            <td>${BigInt(_order.capacity)}</td>
            <td>${_order.orderAmount}</td>
            <td>${_order.sudtAmount}</td>
            <td title=${_order.outPoint}>${_order.outPoint}</td>
            </tr>`,
          )
          .join('')
        _table.innerHTML = rows
      }

      const updateDealTable = (_table, _deals) => {
        const rows = _deals
          .map(
            (_deal, _idx) =>
              `<tr>
            <td>${_idx + 1}</td>
            <td>${_deal.txHash}</td>
            <td>${_deal.fee}</td>
            <td>${_deal.status}</td>
            <td>${_deal.createdAt}</td>
            </tr>`,
          )
          .join('')
        _table.innerHTML = rows
      }

      const updateConfigTable = (_table, _config) => {
        const rows = `
        <tr>
          <td>Remote URL</td>
          <td>${_config.remoteUrl}</td>
        </tr>
        <tr>
          <td>Key File</td>
          <td>${_config.keyFile}</td>
        </tr>
        <tr>
          <td>Fee Rate</td>
          <td>${_config.feeRate}</td>
        </tr>
        `
        _table.innerHTML = rows
      }

      const updateSyncStateTable = (_table, _state) => {
        const rows = `
          <tr>
            <td>Tip</td>
            <td>${_state.tip}</td>
          </tr>
        `
        _table.innerHTML = rows
      }

      socket.on('stat', stat => {
        updateOrderTable(askOrderTable, stat.askOrders)
        updateOrderTable(bidOrderTable, stat.bidOrders)
        updateDealTable(dealTable, stat.deals)
        updateConfigTable(configTable, stat.config)
        updateSyncStateTable(syncStateTable, stat.syncState)
      })

    </script>
  </body>
</html>
